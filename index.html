<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Aircraft Game</title>
<style>
  body {
    margin: 0;
    background: black;
    overflow: hidden;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }

  canvas {
    background: url("assets/background.png") no-repeat center center / cover;
    aspect-ratio: 3 / 4;
    width: 75vmin;
    height: auto;
    border: 2px solid #333;
    display: block;
  }

  #lives {
    position: absolute;
    top: 10px;
    left: 10px;
    display: flex;
    gap: 5px;
  }

  #lives img {
    width: 30px;
    height: 30px;
  }
</style>
</head>
<body>
<canvas id="gameCanvas"></canvas>
<div id="lives"></div>
<audio id="bgm" src="sounds/bgm.mpeg" loop autoplay></audio>

<script>
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
canvas.width = 450;  // 3:4 ratio
canvas.height = 600;

const bg = new Image();  bg.src = "assets/background.png";
const playerImg = new Image(); playerImg.src = "assets/player.png";
const enemyImg = new Image();  enemyImg.src = "assets/enemy.png";
const bossImg = new Image();   bossImg.src = "assets/boss.png";
const bulletGreen = new Image(); bulletGreen.src = "assets/bullet_green.png";
const bulletRed = new Image();   bulletRed.src = "assets/bullet_red.png";
const heartImg = new Image(); heartImg.src = "assets/heart.png";

const bgm = document.getElementById("bgm");
bgm.volume = 0.5;

const player = { x: canvas.width/2 - 25, y: canvas.height - 90, w: 50, h: 50, speed: 5 };
let bullets = [];
let enemies = [];
let enemyBullets = [];
let bossBullets = [];
let boss = null;
let lastEnemySpawn = 0;
let lastBossFire = 0;
let bossSpawned = false;
let lastShot = 0;
let lives = 3;
const livesDiv = document.getElementById("lives");

function updateLives() {
  livesDiv.innerHTML = "";
  for (let i = 0; i < lives; i++) {
    const heart = document.createElement("img");
    heart.src = "assets/heart.png";
    livesDiv.appendChild(heart);
  }
}
updateLives();

document.addEventListener("mousemove", (e) => {
  const rect = canvas.getBoundingClientRect();
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;
  player.x = (e.clientX - rect.left) * scaleX - player.w / 2;
  player.y = (e.clientY - rect.top) * scaleY - player.h / 2;
});

function shoot() {
  const now = Date.now();
  if (now - lastShot > 300) {
    bullets.push({ x: player.x + player.w/2 - 5, y: player.y, w: 10, h: 20, speed: 7 });
    lastShot = now;
  }
}

function spawnEnemies(timestamp) {
  if (timestamp - lastEnemySpawn > 2600) {
    enemies.push({ x: Math.random() * (canvas.width - 40), y: -40, w: 40, h: 40, speed: 2 });
    lastEnemySpawn = timestamp;
  }
}

function bossFire(timestamp) {
  if (boss && timestamp - lastBossFire > 1500) {
    bossBullets.push({ x: boss.x + boss.w/2 - 5, y: boss.y + boss.h, w: 10, h: 20, speed: 5 });
    lastBossFire = timestamp;
  }
}

function drawAll() {
  ctx.drawImage(bg, 0, 0, canvas.width, canvas.height);
  ctx.drawImage(playerImg, player.x, player.y, player.w, player.h);
  bullets.forEach(b => { b.y -= b.speed; ctx.drawImage(bulletGreen, b.x, b.y, b.w, b.h); });
  enemies.forEach(e => { e.y += e.speed; ctx.drawImage(enemyImg, e.x, e.y, e.w, e.h); });
  bossBullets.forEach(b => { b.y += b.speed; ctx.drawImage(bulletRed, b.x, b.y, b.w, b.h); });
  if (boss) ctx.drawImage(bossImg, boss.x, boss.y, boss.w, boss.h);
}

function isCollide(a,b){
  return a.x < b.x + b.w && a.x + a.w > b.x && a.y < b.y + b.h && a.y + a.h > b.y;
}

function handleCollisions() {
  // bullets vs enemies
  enemies = enemies.filter(e => {
    let hit = false;
    bullets = bullets.filter(b => {
      if (isCollide(b,e)) hit = true;
      return !isCollide(b,e);
    });
    return !hit;
  });

  // player vs enemy bullets
  bossBullets = bossBullets.filter(b => {
    if (isCollide(b, player)) {
      lives--;
      updateLives();
      return false;
    }
    return true;
  });

  if (lives <= 0) {
    alert("Game Over!");
    document.location.reload();
  }

  // bullets vs boss
  if (boss) {
    bullets = bullets.filter(b => {
      if (isCollide(b,boss)) {
        boss.hp -= 1;
        return false;
      }
      return true;
    });
    if (boss.hp <= 0) boss = null;
  }
}

function update(timestamp) {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  shoot();
  spawnEnemies(timestamp);
  handleCollisions();
  drawAll();

  if (!bossSpawned && timestamp > 30000) {
    boss = { x: canvas.width/2 - 60, y: 30, w: 120, h: 120, speed: 1, dir: 1, hp: 25 };
    bossSpawned = true;
  }

  if (boss) {
    boss.x += boss.speed * boss.dir;
    if (boss.x <= 0 || boss.x + boss.w >= canvas.width) boss.dir *= -1;
    bossFire(timestamp);
  }

  requestAnimationFrame(update);
}

requestAnimationFrame(update);
</script>
</body>
</html>
