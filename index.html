<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Aircraft Game</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: black;
      overflow: hidden;
      height: 100vh;
      width: 100vw;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    canvas {
      background: url('./assets/background.png') repeat-y;
      background-size: cover;
      height: 80vh;
      width: 90vw;
      display: block;
      border: 2px solid #333;
    }
    #overlay {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      font-family: Arial, sans-serif;
      font-size: 18px;
      z-index: 10;
    }
    #overlay img {
      width: 24px;
      height: 24px;
      margin-right: 5px;
    }
    #popup {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      color: yellow;
      font-size: 22px;
      font-weight: bold;
      font-family: Arial;
      display: none;
      animation: fadeOut 1s ease forwards;
    }
    @keyframes fadeOut {
      0% { opacity: 1; }
      100% { opacity: 0; transform: translate(-50%, -80%); }
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>
  <div id="overlay">
    <span id="score">Score: 0</span>
    <span id="lives"></span>
  </div>
  <div id="popup"></div>
  <audio id="bgm" src="./sounds/bgm.mpeg" loop></audio>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth * 0.9;
    canvas.height = window.innerHeight * 0.8;

    // Load images
    const playerImg = new Image();
    playerImg.src = "./assets/player.png";
    const enemyImg = new Image();
    enemyImg.src = "./assets/enemy.png";
    const bossImg = new Image();
    bossImg.src = "./assets/boss.png";
    const bulletGreen = new Image();
    bulletGreen.src = "./assets/bullet_green.png";
    const bulletRed = new Image();
    bulletRed.src = "./assets/bullet_red.png";
    const heartImg = new Image();
    heartImg.src = "./assets/heart.png";
    const powerDouble = new Image();
    powerDouble.src = "./assets/power_double_fire.png";
    const powerShield = new Image();
    powerShield.src = "./assets/power_shield.png";
    const powerLife = new Image();
    powerLife.src = "./assets/power_extra_life.png";

    const bgm = document.getElementById("bgm");
    bgm.volume = 0.5;
    bgm.play();

    // Player
    const player = {
      x: canvas.width / 2 - 25,
      y: canvas.height - 100,
      width: 60,
      height: 60,
      speed: 10,
      dx: 0,
      bullets: [],
      lives: 3,
      doubleFire: false,
      hitCount: 0
    };

    // Swipe control
    let touchStartX = 0;
    let touchEndX = 0;
    canvas.addEventListener("touchstart", (e) => {
      touchStartX = e.touches[0].clientX;
    });
    canvas.addEventListener("touchmove", (e) => {
      touchEndX = e.touches[0].clientX;
      const diff = touchEndX - touchStartX;
      player.x += diff * 0.3;
      if (player.x < 0) player.x = 0;
      if (player.x + player.width > canvas.width) player.x = canvas.width - player.width;
      touchStartX = touchEndX;
    });

    const bullets = [];
    const enemies = [];
    const bosses = [];
    const enemyBullets = [];
    const powers = [];

    let score = 0;
    let backgroundY = 0;

    function showPopup(text) {
      const popup = document.getElementById("popup");
      popup.innerText = text;
      popup.style.display = "block";
      setTimeout(() => popup.style.display = "none", 800);
    }

    function spawnEnemy() {
      const enemy = {
        x: Math.random() * (canvas.width - 50),
        y: -60,
        width: 50,
        height: 50,
        health: 3
      };
      enemies.push(enemy);
    }

    function spawnPower() {
      const rand = Math.random();
      let type, img;
      if (rand < 0.33) { type = "double"; img = powerDouble; }
      else if (rand < 0.66) { type = "shield"; img = powerShield; }
      else { type = "life"; img = powerLife; }

      const power = {
        x: Math.random() * (canvas.width - 40),
        y: -50,
        width: 40,
        height: 40,
        type,
        img
      };
      powers.push(power);
    }

    function spawnBoss() {
      const boss = {
        x: Math.random() * (canvas.width - 100),
        y: -100,
        width: 120,
        height: 120,
        health: 40
      };
      bosses.push(boss);
    }

    function fireBullet() {
      const bulletX = player.x + player.width / 2 - 5;
      if (player.doubleFire) {
        bullets.push({ x: bulletX - 20, y: player.y, width: 10, height: 20 });
        bullets.push({ x: bulletX + 20, y: player.y, width: 10, height: 20 });
      } else {
        bullets.push({ x: bulletX, y: player.y, width: 10, height: 20 });
      }
    }

    setInterval(() => {
      fireBullet();
    }, 200); // player fire rate 0.2 sec

    setInterval(spawnEnemy, 4000); // enemy spawn every 4 sec
    setInterval(spawnPower, 2000); // power spawn every 2 sec

    function fireEnemyBullet(enemy) {
      enemyBullets.push({
        x: enemy.x + enemy.width / 2 - 5,
        y: enemy.y + enemy.height,
        width: 8,
        height: 20
      });
    }

    setInterval(() => {
      enemies.forEach((e) => fireEnemyBullet(e));
      bosses.forEach((b) => {
        for (let i = -2; i <= 2; i++) {
          enemyBullets.push({
            x: b.x + b.width / 2 + i * 15,
            y: b.y + b.height,
            width: 8,
            height: 20
          });
        }
      });
    }, 1500); // enemy fire rate 1.5 sec

    function update() {
      backgroundY += 2;
      if (backgroundY >= canvas.height) backgroundY = 0;

      // Move bullets
      bullets.forEach((b, i) => {
        b.y -= 10;
        if (b.y < 0) bullets.splice(i, 1);
      });

      // Move enemies
      enemies.forEach((e, ei) => {
        e.y += 2;
        if (e.y > canvas.height) enemies.splice(ei, 1);
      });

      // Move bosses
      bosses.forEach((b, bi) => {
        b.y += 1;
        if (b.y > canvas.height - 200) b.y = canvas.height - 200;
      });

      // Move powers
      powers.forEach((p, pi) => {
        p.y += 3;
        if (p.y > canvas.height) powers.splice(pi, 1);
      });

      // Enemy bullets
      enemyBullets.forEach((b, i) => {
        b.y += 5;
        if (b.y > canvas.height) enemyBullets.splice(i, 1);
      });

      // Collisions
      bullets.forEach((b, bi) => {
        enemies.forEach((e, ei) => {
          if (b.x < e.x + e.width && b.x + b.width > e.x && b.y < e.y + e.height && b.y + b.height > e.y) {
            e.health--;
            bullets.splice(bi, 1);
            if (e.health <= 0) {
              enemies.splice(ei, 1);
              score += 10;
            }
          }
        });

        bosses.forEach((bs, bsi) => {
          if (b.x < bs.x + bs.width && b.x + b.width > bs.x && b.y < bs.y + bs.height && b.y + b.height > bs.y) {
            bs.health--;
            bullets.splice(bi, 1);
            if (bs.health <= 0) {
              bosses.splice(bsi, 1);
              score += 50;
            }
          }
        });
      });

      // Power pickup
      powers.forEach((p, pi) => {
        if (p.x < player.x + player.width && p.x + p.width > player.x && p.y < player.y + player.height && p.y + p.height > player.y) {
          if (p.type === "double") { player.doubleFire = true; showPopup("2X FIRE"); }
          if (p.type === "shield") { showPopup("SHIELD!"); }
          if (p.type === "life") { player.lives++; showPopup("LIFE UP!"); }
          powers.splice(pi, 1);
        }
      });

      // Enemy bullet hit player
      enemyBullets.forEach((b, i) => {
        if (b.x < player.x + player.width && b.x + b.width > player.x && b.y < player.y + player.height && b.y + b.height > player.y) {
          player.hitCount++;
          enemyBullets.splice(i, 1);
          if (player.hitCount >= 3) {
            player.lives--;
            player.hitCount = 0;
            if (player.lives <= 0) alert("Game Over! Final Score: " + score);
          }
        }
      });

      // Boss spawn logic
      if (score >= 200 && score % 200 === 0 && bosses.length === 0) spawnBoss();

      draw();
      requestAnimationFrame(update);
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      ctx.drawImage(document.querySelector("canvas").style.backgroundImage, 0, backgroundY - canvas.height, canvas.width, canvas.height);
      ctx.drawImage(document.querySelector("canvas").style.backgroundImage, 0, backgroundY, canvas.width, canvas.height);

      ctx.drawImage(playerImg, player.x, player.y, player.width, player.height);
      bullets.forEach(b => ctx.drawImage(bulletGreen, b.x, b.y, b.width, b.height));
      enemies.forEach(e => ctx.drawImage(enemyImg, e.x, e.y, e.width, e.height));
      bosses.forEach(b => ctx.drawImage(bossImg, b.x, b.y, b.width, b.height));
      enemyBullets.forEach(b => ctx.drawImage(bulletRed, b.x, b.y, b.width, b.height));
      powers.forEach(p => ctx.drawImage(p.img, p.x, p.y, p.width, p.height));

      const livesDiv = document.getElementById("lives");
      livesDiv.innerHTML = "";
      for (let i = 0; i < player.lives; i++) {
        const heart = document.createElement("img");
        heart.src = "./assets/heart.png";
        livesDiv.appendChild(heart);
      }
      document.getElementById("score").textContent = "Score: " + score;
    }

    update();
  </script>
</body>
</html>
