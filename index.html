<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aircraft Game</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
    }
    canvas {
      display: block;
      background: black;
    }
  </style>
</head>
<body>
  <audio id="bgm" src="sounds/bgm.mpeg" loop></audio>
  <canvas id="gameCanvas"></canvas>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // Load images
    const bgImg = new Image(); bgImg.src = "assets/background.png";
    const playerImg = new Image(); playerImg.src = "assets/player.png";
    const enemyImg = new Image(); enemyImg.src = "assets/enemy.png";
    const bossImg = new Image(); bossImg.src = "assets/boss.png";
    const bulletGreenImg = new Image(); bulletGreenImg.src = "assets/bullet_green.png";
    const bulletRedImg = new Image(); bulletRedImg.src = "assets/bullet_red.png";
    const powerDoubleImg = new Image(); powerDoubleImg.src = "assets/power_double_fire.png";
    const powerShieldImg = new Image(); powerShieldImg.src = "assets/power_shield.png";
    const powerLifeImg = new Image(); powerLifeImg.src = "assets/power_extra_life.png";
    const heartImg = new Image(); heartImg.src = "assets/heart.png";

    // Background scroll
    let bgY = 0;

    // Player setup
    const player = {
      x: canvas.width / 2 - 40,
      y: canvas.height - 120,
      width: 80,
      height: 80,
      speed: 10,
      lives: 3,
      shield: false,
      doubleFire: false
    };

    let bullets = [];
    let enemies = [];
    let enemyBullets = [];
    let powers = [];
    let bosses = [];
    let score = 0;
    let keys = {};
    let lastEnemySpawn = 0;
    let lastEnemyFire = 0;
    let lastShot = 0;

    // --- BGM fix for mobile ---
    const bgm = document.getElementById("bgm");
    document.body.addEventListener("click", () => {
      bgm.play().catch(() => {});
    });

    // Keyboard controls
    document.addEventListener("keydown", e => keys[e.key] = true);
    document.addEventListener("keyup", e => keys[e.key] = false);

    // Touch controls (drag)
    document.addEventListener("touchmove", e => {
      const touch = e.touches[0];
      const rect = canvas.getBoundingClientRect();
      player.x = touch.clientX - rect.left - player.width / 2;
      player.y = touch.clientY - rect.top - player.height / 2;
    });

    // Background draw
    function drawBackground() {
      bgY += 2;
      if (bgY > canvas.height) bgY = 0;
      ctx.drawImage(bgImg, 0, bgY - canvas.height, canvas.width, canvas.height);
      ctx.drawImage(bgImg, 0, bgY, canvas.width, canvas.height);
    }

    // Draw player
    function drawPlayer() {
      ctx.drawImage(playerImg, player.x, player.y, player.width, player.height);
    }

    // Shooting
    function shoot() {
      const now = Date.now();
      if (now - lastShot > 300) {
        bullets.push({ x: player.x + player.width / 2 - 5, y: player.y - 10 });
        if (player.doubleFire) {
          bullets.push({ x: player.x + 10, y: player.y - 10 });
          bullets.push({ x: player.x + player.width - 20, y: player.y - 10 });
        }
        lastShot = now;
      }
    }

    // Player movement
    function handleInput() {
      if (keys["ArrowLeft"] && player.x > 0) player.x -= player.speed;
      if (keys["ArrowRight"] && player.x + player.width < canvas.width) player.x += player.speed;
      if (keys["ArrowUp"] && player.y > 0) player.y -= player.speed;
      if (keys["ArrowDown"] && player.y + player.height < canvas.height) player.y += player.speed;
      if (keys[" "] || keys["Spacebar"]) shoot();
    }

    // Spawn enemies
    function spawnEnemies() {
      const now = Date.now();
      if (now - lastEnemySpawn > 3000) { // 3 sec
        enemies.push({
          x: Math.random() * (canvas.width - 60),
          y: -50,
          width: 60,
          height: 60,
          speed: 3
        });
        lastEnemySpawn = now;
      }
    }

    // Enemy fire
    function enemiesFire() {
      const now = Date.now();
      if (now - lastEnemyFire > 2000) { // 2 sec
        enemies.forEach(e => {
          enemyBullets.push({ x: e.x + e.width / 2, y: e.y + e.height });
        });
        lastEnemyFire = now;
      }
    }

    // Update all bullets
    function updateBullets() {
      bullets.forEach(b => b.y -= 10);
      bullets = bullets.filter(b => b.y > 0);
      enemyBullets.forEach(b => b.y += 7);
      enemyBullets = enemyBullets.filter(b => b.y < canvas.height);
    }

    // Move enemies
    function updateEnemies() {
      enemies.forEach(e => e.y += e.speed);
      enemies = enemies.filter(e => e.y < canvas.height);
    }

    // Spawn powers
    function spawnPower(x, y) {
      const types = ["double", "shield", "life"];
      const type = types[Math.floor(Math.random() * types.length)];
      const img = type === "double" ? powerDoubleImg : type === "shield" ? powerShieldImg : powerLifeImg;
      powers.push({ x, y, type, img });
    }

    // Collisions
    function checkCollisions() {
      bullets.forEach((b, bi) => {
        enemies.forEach((e, ei) => {
          if (b.x < e.x + e.width && b.x + 10 > e.x && b.y < e.y + e.height && b.y + 20 > e.y) {
            bullets.splice(bi, 1);
            enemies.splice(ei, 1);
            score += 10;
            if (Math.random() < 0.2) spawnPower(e.x, e.y);
          }
        });
      });

      powers.forEach((p, pi) => {
        if (p.x < player.x + player.width && p.x + 30 > player.x && p.y < player.y + player.height && p.y + 30 > player.y) {
          if (p.type === "double") player.doubleFire = true;
          if (p.type === "shield") player.shield = true;
          if (p.type === "life") player.lives++;
          powers.splice(pi, 1);
        }
      });
    }

    // Draw all entities
    function drawAll() {
      drawBackground();
      drawPlayer();

      bullets.forEach(b => ctx.drawImage(bulletGreenImg, b.x, b.y, 10, 20));
      enemies.forEach(e => ctx.drawImage(enemyImg, e.x, e.y, e.width, e.height));
      enemyBullets.forEach(b => ctx.drawImage(bulletRedImg, b.x, b.y, 8, 15));
      powers.forEach(p => ctx.drawImage(p.img, p.x, p.y, 30, 30));

      ctx.fillStyle = "white";
      ctx.font = "20px Arial";
      ctx.fillText("Score: " + score, 20, 30);
      for (let i = 0; i < player.lives; i++) {
        ctx.drawImage(heartImg, 20 + i * 30, 40, 25, 25);
      }
    }

    // Main loop
    function update() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      handleInput();
      spawnEnemies();
      enemiesFire();
      updateEnemies();
      updateBullets();
      checkCollisions();
      drawAll();
      requestAnimationFrame(update);
    }

    update();
  </script>
</body>
</html>
