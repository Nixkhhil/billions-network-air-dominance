<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Aircraft Game</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: black;
    }
    canvas {
      display: block;
      margin: auto;
      background: url("assets/background.png") repeat-y center;
      background-size: cover;
    }
  </style>
</head>
<body>
  <audio id="bgm" src="sounds/bgm.mpeg" autoplay loop></audio>
  <canvas id="gameCanvas"></canvas>

  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    // Load images
    const playerImg = new Image(); playerImg.src = "assets/player.png";
    const enemyImg = new Image(); enemyImg.src = "assets/enemy.png";
    const bossImg = new Image(); bossImg.src = "assets/boss.png";
    const bulletGreenImg = new Image(); bulletGreenImg.src = "assets/bullet_green.png";
    const bulletRedImg = new Image(); bulletRedImg.src = "assets/bullet_red.png";
    const heartImg = new Image(); heartImg.src = "assets/heart.png";
    const powerDoubleImg = new Image(); powerDoubleImg.src = "assets/power_double_fire.png";
    const powerShieldImg = new Image(); powerShieldImg.src = "assets/power_shield.png";
    const powerLifeImg = new Image(); powerLifeImg.src = "assets/power_extra_life.png";

    // Background scroll setup
    let bgY = 0;

    // Game vars
    let player = { x: canvas.width / 2 - 40, y: canvas.height - 120, width: 80, height: 80, speed: 10, lives: 3, shield: false, doubleFire: false };
    let bullets = [];
    let enemies = [];
    let enemyBullets = [];
    let powers = [];
    let bosses = [];
    let score = 0;
    let keys = {};
    let lastEnemySpawn = 0;
    let lastEnemyFire = 0;
    let lastBossSpawn = 0;

    // BGM play fix for mobile
    const bgm = document.getElementById("bgm");
    document.body.addEventListener("click", () => {
      bgm.play().catch(() => {});
    });

    // Event listeners
    document.addEventListener("keydown", e => keys[e.key] = true);
    document.addEventListener("keyup", e => keys[e.key] = false);
    document.addEventListener("touchmove", e => {
      const touch = e.touches[0];
      player.x = touch.clientX - player.width / 2;
      player.y = touch.clientY - player.height / 2;
    });

    function drawBackground() {
      bgY += 2;
      if (bgY >= canvas.height) bgY = 0;
      ctx.drawImage(document.createElement("img"), 0, bgY - canvas.height, canvas.width, canvas.height);
      ctx.drawImage(document.createElement("img"), 0, bgY, canvas.width, canvas.height);
    }

    function drawPlayer() {
      ctx.drawImage(playerImg, player.x, player.y, player.width, player.height);
    }

    function drawBullets() {
      ctx.fillStyle = "lime";
      bullets.forEach(b => {
        ctx.drawImage(bulletGreenImg, b.x, b.y, 10, 20);
        b.y -= 10;
      });
      bullets = bullets.filter(b => b.y > 0);
    }

    function drawEnemies() {
      enemies.forEach(e => {
        ctx.drawImage(enemyImg, e.x, e.y, e.width, e.height);
        e.y += e.speed;
      });
      enemies = enemies.filter(e => e.y < canvas.height);
    }

    function drawEnemyBullets() {
      enemyBullets.forEach(b => {
        ctx.drawImage(bulletRedImg, b.x, b.y, 8, 15);
        b.y += 7;
      });
      enemyBullets = enemyBullets.filter(b => b.y < canvas.height);
    }

    function drawPowers() {
      powers.forEach(p => {
        ctx.drawImage(p.img, p.x, p.y, 30, 30);
        p.y += 3;
      });
      powers = powers.filter(p => p.y < canvas.height);
    }

    function drawBosses() {
      bosses.forEach(boss => {
        ctx.drawImage(bossImg, boss.x, boss.y, boss.width, boss.height);
        boss.y += boss.speed;
      });
      bosses = bosses.filter(boss => boss.y < canvas.height);
    }

    function handleInput() {
      if (keys["ArrowLeft"] && player.x > 0) player.x -= player.speed;
      if (keys["ArrowRight"] && player.x + player.width < canvas.width) player.x += player.speed;
      if (keys[" "] || keys["Spacebar"]) shoot();
    }

    let lastShot = 0;
    function shoot() {
      const now = Date.now();
      if (now - lastShot > 300) {
        bullets.push({ x: player.x + player.width / 2 - 5, y: player.y - 10 });
        if (player.doubleFire) {
          bullets.push({ x: player.x + 10, y: player.y - 10 });
          bullets.push({ x: player.x + player.width - 20, y: player.y - 10 });
        }
        lastShot = now;
      }
    }

    function spawnEnemies() {
      const now = Date.now();
      if (now - lastEnemySpawn > 3500) {
        enemies.push({ x: Math.random() * (canvas.width - 50), y: -50, width: 60, height: 60, speed: 3 });
        lastEnemySpawn = now;
      }
    }

    function enemiesFire() {
      const now = Date.now();
      if (now - lastEnemyFire > 2000) {
        enemies.forEach(e => {
          enemyBullets.push({ x: e.x + e.width / 2, y: e.y + e.height });
        });
        lastEnemyFire = now;
      }
    }

    function spawnBoss() {
      if (score >= 200 && score % 200 === 0) {
        bosses.push({ x: Math.random() * (canvas.width - 150), y: -150, width: 150, height: 150, speed: 2 });
      }
    }

    function checkCollisions() {
      bullets.forEach((b, bi) => {
        enemies.forEach((e, ei) => {
          if (b.x < e.x + e.width && b.x + 10 > e.x && b.y < e.y + e.height && b.y + 20 > e.y) {
            enemies.splice(ei, 1);
            bullets.splice(bi, 1);
            score += 10;
            if (Math.random() < 0.2) spawnPower(e.x, e.y);
          }
        });
      });

      powers.forEach((p, pi) => {
        if (p.x < player.x + player.width && p.x + 30 > player.x && p.y < player.y + player.height && p.y + 30 > player.y) {
          if (p.type === "double") player.doubleFire = true;
          if (p.type === "shield") player.shield = true;
          if (p.type === "life") player.lives++;
          powers.splice(pi, 1);
        }
      });
    }

    function spawnPower(x, y) {
      const types = ["double", "shield", "life"];
      const type = types[Math.floor(Math.random() * types.length)];
      const img = type === "double" ? powerDoubleImg : type === "shield" ? powerShieldImg : powerLifeImg;
      powers.push({ x, y, type, img });
    }

    function drawHUD() {
      ctx.fillStyle = "white";
      ctx.font = "20px Arial";
      ctx.fillText("Score: " + score, 20, 30);
      for (let i = 0; i < player.lives; i++) {
        ctx.drawImage(heartImg, 20 + i * 30, 40, 25, 25);
      }
    }

    function update() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);

      // background scroll
      bgY += 2;
      ctx.drawImage(document.createElement("img"), 0, bgY - canvas.height, canvas.width, canvas.height);
      ctx.drawImage(document.createElement("img"), 0, bgY, canvas.width, canvas.height);
      if (bgY >= canvas.height) bgY = 0;

      handleInput();
      spawnEnemies();
      enemiesFire();
      spawnBoss();
      checkCollisions();

      drawPlayer();
      drawBullets();
      drawEnemies();
      drawEnemyBullets();
      drawPowers();
      drawBosses();
      drawHUD();

      requestAnimationFrame(update);
    }

    update();
  </script>
</body>
</html>
