<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>Aircraft Game</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: black;
      overflow: hidden;
      touch-action: none;
    }
    canvas {
      display: block;
      margin: auto;
      width: 100vw;
      height: 100vh;
      background: black;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="360" height="640"></canvas>
  <script>
    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");

    // Responsive scaling
    function resizeCanvas() {
      const ratio = 360 / 640;
      let w = window.innerWidth;
      let h = window.innerHeight;
      if (w / h > ratio) w = h * ratio;
      else h = w / ratio;
      canvas.style.width = w + "px";
      canvas.style.height = h + "px";
    }
    window.addEventListener("resize", resizeCanvas);
    resizeCanvas();

    // ===== Load Images =====
    const img = {};
    const load = (n) => { img[n] = new Image(); img[n].src = `assets/${n}.png`; };
    [
      "background", "player", "enemy", "boss",
      "bullet_green", "bullet_red",
      "power_double_fire", "power_shield", "power_extra_life",
      "heart"
    ].forEach(load);

    // ===== Sound =====
    const bgm = new Audio("sounds/bgm.mpeg");
    bgm.loop = true;
    bgm.volume = 0.4;
    bgm.play().catch(()=>{});

    // ===== Game Variables =====
    let bullets=[], enemies=[], enemyBullets=[], powers=[];
    let boss=null;
    let score=0, lives=3;
    let hasShield=false, doubleFire=false;
    let lastEnemySpawn=0, lastEnemyFire=0, lastPlayerFire=0;
    let lastBossSpawnScore=0, gameOver=false;

    const player = {x:canvas.width/2-25, y:canvas.height-80, w:50, h:50, speed:6, draw(){
      ctx.drawImage(img.player,this.x,this.y,this.w,this.h);
    }};

    // ===== Touch controls =====
    let startX=null;
    canvas.addEventListener("touchstart",(e)=>{ startX=e.touches[0].clientX; });
    canvas.addEventListener("touchmove",(e)=>{
      const diff = e.touches[0].clientX - startX;
      player.x += diff*0.4;
      if(player.x<0) player.x=0;
      if(player.x>canvas.width-player.w) player.x=canvas.width-player.w;
      startX=e.touches[0].clientX;
    });

    // ===== Player Fire =====
    function playerFire(){
      if(performance.now()-lastPlayerFire<200)return;
      lastPlayerFire=performance.now();
      if(doubleFire){
        bullets.push({x:player.x+5,y:player.y,w:8,h:20});
        bullets.push({x:player.x+player.w-13,y:player.y,w:8,h:20});
      }else{
        bullets.push({x:player.x+player.w/2-4,y:player.y,w:8,h:20});
      }
    }

    // ===== Enemies =====
    function spawnEnemy(){
      if(performance.now()-lastEnemySpawn<3500)return;
      lastEnemySpawn=performance.now();
      enemies.push({x:Math.random()*(canvas.width-40),y:-40,w:40,h:40,speed:2});
    }

    function enemyFire(){
      if(performance.now()-lastEnemyFire<2000)return;
      lastEnemyFire=performance.now();
      enemies.forEach(e=>{
        enemyBullets.push({x:e.x+e.w/2-4,y:e.y+e.h,w:8,h:20});
      });
      if(boss){
        // boss fires 3 spread bullets
        for(let i=-1;i<=1;i++){
          enemyBullets.push({x:boss.x+boss.w/2-4+20*i,y:boss.y+boss.h,w:8,h:20});
        }
      }
    }

    function spawnBoss(){
      if(score>=lastBossSpawnScore+200){
        boss={x:canvas.width/2-60,y:50,w:120,h:80,hp:40};
        lastBossSpawnScore=score;
      }
    }

    function spawnPower(x,y){
      const type=["power_double_fire","power_shield","power_extra_life"][Math.floor(Math.random()*3)];
      powers.push({type,x,y,w:30,h:30,speed:2});
    }

    // ===== Update =====
    function update(){
      if(gameOver)return;
      playerFire();

      bullets.forEach(b=>b.y-=8);
      bullets=bullets.filter(b=>b.y>-20);

      spawnEnemy();
      enemies.forEach(e=>e.y+=e.speed);
      enemies=enemies.filter(e=>e.y<canvas.height);

      enemyFire();
      enemyBullets.forEach(b=>b.y+=5);
      enemyBullets=enemyBullets.filter(b=>b.y<canvas.height);

      powers.forEach(p=>p.y+=p.speed);
      powers=powers.filter(p=>p.y<canvas.height);

      spawnBoss();
      if(boss) boss.x += Math.sin(performance.now()/500)*2;

      // collisions
      bullets.forEach((b,bi)=>{
        enemies.forEach((e,ei)=>{
          if(b.x<e.x+e.w&&b.x+b.w>e.x&&b.y<e.y+e.h&&b.y+b.h>e.y){
            e.hp=(e.hp||3)-1;
            bullets.splice(bi,1);
            if(e.hp<=0){
              enemies.splice(ei,1);
              score+=10;
              if(Math.random()<0.3)spawnPower(e.x,e.y);
            }
          }
        });

        if(boss&&b.x<boss.x+boss.w&&b.x+b.w>boss.x&&b.y<boss.y+boss.h&&b.y+b.h>boss.y){
          boss.hp--;
          bullets.splice(bi,1);
          if(boss.hp<=0){boss=null;score+=100;spawnPower(player.x,100);}
        }
      });

      enemyBullets.forEach((b,i)=>{
        if(b.x<player.x+player.w&&b.x+b.w>player.x&&b.y<player.y+player.h&&b.y+b.h>player.y){
          enemyBullets.splice(i,1);
          if(hasShield){hasShield=false;return;}
          player.hitCount=(player.hitCount||0)+1;
          if(player.hitCount>=3){
            lives--;player.hitCount=0;
            if(lives<=0)gameOver=true;
          }
        }
      });

      powers.forEach((p,i)=>{
        if(p.x<player.x+player.w&&p.x+p.w>player.x&&p.y<player.y+player.h&&p.y+p.h>player.y){
          powers.splice(i,1);
          if(p.type==="power_double_fire")doubleFire=true;
          else if(p.type==="power_shield")hasShield=true;
          else if(p.type==="power_extra_life")lives++;
        }
      });
    }

    // ===== Draw =====
    function draw(){
      ctx.drawImage(img.background,0,0,canvas.width,canvas.height);
      player.draw();
      bullets.forEach(b=>ctx.drawImage(img.bullet_green,b.x,b.y,b.w,b.h));
      enemies.forEach(e=>ctx.drawImage(img.enemy,e.x,e.y,e.w,e.h));
      enemyBullets.forEach(b=>ctx.drawImage(img.bullet_red,b.x,b.y,b.w,b.h));
      powers.forEach(p=>ctx.drawImage(img[p.type],p.x,p.y,p.w,p.h));
      if(boss)ctx.drawImage(img.boss,boss.x,boss.y,boss.w,boss.h);

      ctx.fillStyle="white";
      ctx.font="16px Arial";
      ctx.fillText(`Score: ${score}`,10,20);
      for(let i=0;i<lives;i++)ctx.drawImage(img.heart,10+i*25,30,20,20);
      if(hasShield)ctx.fillText("ðŸ›¡ï¸ Shield",10,70);
      if(doubleFire)ctx.fillText("ðŸ”¥ Double Fire",10,90);
      if(gameOver){
        ctx.fillStyle="red";
        ctx.font="28px Arial";
        ctx.fillText("GAME OVER",canvas.width/2-80,canvas.height/2);
      }
    }

    // ===== Main Loop =====
    function loop(){update();draw();requestAnimationFrame(loop);}
    loop();
  </script>
</body>
</html>
